
<!DOCTYPE html>
<html>
  <head>
    <title>Innovation Week Sept 2015</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script language="javascript" type="text/javascript" src="js/jquery-1.10.2.min.js"></script>
    <script language="javascript" type="text/javascript" src="js/voltdb.js"></script>
    <script>

var con;

function checkConnection() {
    console.log("Trying to connect to DB...");
    VoltDB.TestConnection(location.hostname, 8080, false, null, null, false,
                          function(connected){
                              if (connected) {
                                  $('#loadingModal').modal('hide');
                                  console.log("Success!");
                                  connectToDatabase();
                              } else {
                                  checkConnection();
                              }
                          });
}

function connectToDatabase() {

            con = VoltDB.AddConnection(location.hostname, 8080, false, null, null, false, (function(connection, success)
            {
                console.log("Connection added.");
                setInterval(getTaxiLocations, 250);
            }));
        }


var map;
var markers = [];

function getTaxiInfoWindow(taxiId) {
    con.CallExecute('GetTaxiInfo', [taxiId], function(response) {
        var nearbyTaxis = response.results[0].data;
        var nearbyCities = response.results[1].data;

        var lat = markers[taxiId].getPosition().lat();
        var lng = markers[taxiId].getPosition().lng();
        var windowContent = "<h2>Taxi #" + taxiId + "</h2>\n";
        windowContent += "<p>Lat/long: " + lat + ", " + lng + "</p>\n";

        windowContent += '<p>Other taxis within 5 miles:</p>\n';
        windowContent += '<ul>\n';
        for (var i = 0; i < nearbyTaxis.length; ++i) {
            windowContent += '<li>Taxi #' + nearbyTaxis[i] + '</li>\n';
        }
        windowContent += '</ul>\n';

        windowContent += '<p>Places within 5 miles:</p>\n';
        windowContent += '<ul>\n';
        for (var i = 0; i < nearbyCities.length; ++i) {
            windowContent += '<li>' + nearbyCities[i] + '</li>\n';
        }
        windowContent += '</ul>\n';

        var infoWindow = new google.maps.InfoWindow({
            content: windowContent
        });
        infoWindow.open(map, markers[taxiId]);
    });
}

function getTaxiLocations() {
    con.CallExecute('selectTaxiLocations', [], function(response)
    {
        try
        {
            var data = response.results[0].data;
            for (var i = 0; i < data.length; ++i) {
                var latLng = {lat: data[i][0], lng: data[i][1]};
                if (markers.length < data.length) {
                    markers.push(new google.maps.Marker({
                        position: latLng,
                        map: map,
                        title: 'Taxi #' + i,
                        zIndex: i
                    }));
                    markers[i].addListener('click', function() {
                        getTaxiInfoWindow(this.zIndex);
                    });
                                     // (function() {
                                     //     var lat = latLng.lat;
                                     //     var lng = latLng.lng;
                                     //     return function() {

                                     //     }
                                     // } ()));
                }
                else {
                    markers[i].setPosition(latLng);
                }
            }
        }
        catch(x) {
            //console.log(x);
        }
    });
}

function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 40.417193, lng: -95.445279},
    zoom: 5
  });

    $('#loadingModal').modal('show');
    checkConnection();
}

    </script>
    <script src="https://maps.googleapis.com/maps/api/js?callback=initMap"
        async defer></script>
    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" role="dialog"
         aria-labelledby="myModalLabel" aria-hidden="true"
         data-backdrop="static"
         data-keyboard="false">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-body center-block">
            <h4 class="modal-title" id="myModalLabel">Starting database, this may take 30 seconds...</h4>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/bootstrap.min.js"></script>
  </body>
</html>
