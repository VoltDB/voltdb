<!-- Simple build file to build socket stream importer -->
<project name="importers"      basedir="." default="buildbundles">
<property name='base.dir'         location='.' />
<property name='bundles.dir'      location='./bundles' />
<property name='build.dir'        location='obj/${build}' />
<property name='build.prod.dir'   location='${build.dir}/prod' />

    <target name="buildbundles" depends="socketstream, pullsocketimporter, log4jsocketimporter, kafkastream, voltcsvformatter, kinesisstream, kafkastream10"/>

    <resources id="default.imports.resource">
        <string>org.osgi.framework;version=&quot;[1.6,2)&quot;</string>
        <string>org.voltcore.network</string>
        <string>org.voltdb.importer</string>
        <string>org.voltdb.client</string>
        <string>org.voltdb.importer.formatter</string>
        <string>org.apache.log4j</string>
        <string>org.slf4j</string>
        <string>jsr166y</string>
        <string>org.voltcore.utils</string>
        <string>org.voltcore.logging</string>
        <string>com.google_voltpatches.common.base</string>
        <string>com.google_voltpatches.common.collect</string>
        <string>com.google_voltpatches.common.net</string>
        <string>com.google_voltpatches.common.io</string>
        <string>com.google_voltpatches.common.util.concurrent</string>
    </resources>

    <pathconvert property="default.imports" refid="default.imports.resource" pathsep=","/>

    <target name="socketstream">
	    <javac  srcdir="src/frontend"
            destdir="${build.prod.dir}"
            includes="org/voltdb/importclient/socket/**/*.java"
            encoding='UTF-8'
            debug='true'
            includeAntRuntime='false'>            
			<classpath refid="project.classpath"/>
        </javac>
        <antcall target="osgibundle">
            <param name="bundle.name" value="socketstream"/>
            <param name="activator" value="org.voltdb.importclient.socket.ServerSocketImporterFactory"/>
            <param name="bundle.displayname" value="SocketStreamImporter"/>
            <param name="include.classpattern" value="socket/ServerSocket*.class"/>
        </antcall>
    </target>

    <target name="pullsocketimporter">
	    <javac  srcdir="src/frontend"
            destdir="${build.prod.dir}"
            includes="org/voltdb/importclient/socket/**/*.java"
            encoding='UTF-8'
            debug='true'
            includeAntRuntime='false'>            
			<classpath refid="project.classpath"/>
		</javac>
        <mkdir dir="${bundles.dir}" />
        <jar destfile="${bundles.dir}/pullsocketimporter.jar" basedir="${build.prod.dir}">
            <include name="org/voltdb/importclient/socket/PullSocketImporter*.class"/>
            <include name="org/voltdb/importclient/ImportBaseException.class"/>
            <manifest>
                <attribute name="Bundle-Activator" value="org.voltdb.importclient.socket.PullSocketImporterFactory" />
                <attribute name="Bundle-ManifestVersion" value="2" />
                <attribute name="Bundle-Name" value="PullSocketImporter OSGi Bundle" />
                <attribute name="Bundle-SymbolicName" value="PullSocketImporter" />
                <attribute name="Bundle-Version" value="1.0.0" />
                <attribute name="DynamicImport-Package" value="*" />
                <attribute name="Import-Package" value="${default.imports}" />
            </manifest>
        </jar>
    </target>

    <target name="log4jsocketimporter">
    	<javac  srcdir="src/frontend"
            destdir="${build.prod.dir}"
            includes="org/voltdb/importclient/log4j/**/*.java"
            encoding='UTF-8'
            debug='true'
            includeAntRuntime='false'>            
			<classpath refid="project.classpath"/>
		</javac>
        <antcall target="osgibundle">
            <param name="bundle.name" value="log4jsocketimporter"/>
            <param name="activator" value="org.voltdb.importclient.log4j.Log4jSocketImporterFactory"/>
            <param name="bundle.displayname" value="Log4jSocketImporter"/>
            <param name="include.classpattern" value="log4j/*.class"/>
        </antcall>
    </target>

	<!-- Kinesis -->
	
	<target name="kinesisstream">

    	<javac  srcdir="src/frontend"
            destdir="${build.prod.dir}"
            includes="org/voltdb/importclient/kinesis/**/*.java"
            encoding='UTF-8'
            debug='true'
            includeAntRuntime='false'>  
            <!-- NEEDSWORK: Narrow this down -->          
			<classpath refid="project.classpath"/>
		</javac>
	    <mkdir dir="${bundles.dir}" />
	    <jar destfile="${bundles.dir}/kinesisstream.jar" basedir="${build.prod.dir}">
			<include name="org/voltdb/importclient/kinesis/*.class"/>
			<include name="org/voltdb/importclient/ImportBaseException.class"/>
			<zipgroupfileset dir="${base.dir}/third_party/java/jars" includes="amazon-kinesis-client-1.6.2.jar" />
			<zipgroupfileset dir="${base.dir}/third_party/java/jars" includes="aws-java-sdk-1.10.72.jar" />
			<zipgroupfileset dir="${base.dir}/third_party/java/jars" includes="jackson-dataformat-cbor-2.5.3.jar" />
			<zipgroupfileset dir="${base.dir}/third_party/java/jars" includes="jackson-databind-2.5.3.jar" />
			<zipgroupfileset dir="${base.dir}/third_party/java/jars" includes="jackson-core-2.5.3.jar" />
			<zipgroupfileset dir="${base.dir}/third_party/java/jars" includes="jackson-annotations-2.5.0.jar" />
			<zipgroupfileset dir="${base.dir}/third_party/java/jars" includes="joda-time-2.9.3.jar" />
			<zipgroupfileset dir="${base.dir}/third_party/java/jars" includes="commons-lang-2.6.jar" />
			<zipgroupfileset dir="${base.dir}/third_party/java/jars" includes="guava-18.0.jar" />
			<zipgroupfileset dir="${base.dir}/third_party/java/jars" includes="protobuf-java-2.6.1.jar" />
			<zipgroupfileset dir="${base.dir}/lib" includes="commons-logging-1.1.3.jar" />
			<zipgroupfileset dir="${base.dir}/lib" includes="httpclient-4.3.2.jar" />
			<zipgroupfileset dir="${base.dir}/lib" includes="httpcore-4.3.2.jar" />
			<manifest>
				<attribute name="Bundle-Activator" value="org.voltdb.importclient.kinesis.KinesisStreamImporterFactory" />
				<attribute name="Bundle-ManifestVersion" value="2" />
				<attribute name="Bundle-Name" value="KinesisStream OSGi Bundle" />
				<attribute name="Bundle-SymbolicName" value="KinesisStreamImporter" />
				<attribute name="Bundle-Version" value="1.0.0" />
				<attribute name="DynamicImport-Package" value="*" />
				<attribute name="Import-Package" value="org.osgi.framework;version=&quot;[1.6,2)&quot;,org.voltdb.importer,org.voltdb.client,org.slf4j" />
			</manifest>
	    </jar>
	 </target>
	 
	<!-- Kafka 8 -->
	
	<path id="k8classpath">     	
        <pathelement location='${build.client.dir}' />
        <pathelement location='${build.prod.dir}' />
 	    <fileset dir='${lib.dir}'> 
 	        <include name='kafka-clients-0.8.2.2.jar'/>
 	        <include name='kafka_2.11-0.8.2.2.jar'/>
			<include name='log4j-1.2.16.jar'/>
 	        <include name='commons-lang3-3.0.jar'/>
 	        <include name='scala*.jar'/>
 	        <include name='felix.jar'/>
 	    </fileset>
		<fileset dir='${vendor.lib.dir}'>
  		    <include name='junit*.jar'/>
  		</fileset> 	    
 		<fileset refid="voltpro.classpath"/>
 	</path>
 	
    <target name="kafkastream">
	    <!-- 
	    <pathconvert property="classpathProp" refid="k8classpath"/>
 		<echo>Classpath is ${classpathProp}</echo>  
 		-->
		<javac  srcdir="src/frontend"
            destdir="${build.prod.dir}"
            includes="org/voltdb/importclient/kafka/**/*.java"
            encoding='UTF-8'
            debug='true'
            includeAntRuntime='false'>            
			<classpath refid="k8classpath"/>
        </javac>
        <mkdir dir="${bundles.dir}" />
        <jar destfile="${bundles.dir}/kafkastream.jar" basedir="${build.prod.dir}">
            <include name="org/voltdb/importclient/kafka/*.class"/>
            <include name="org/voltdb/importclient/ImportBaseException.class"/>
            <zipgroupfileset dir="${base.dir}/lib/" includes="scala-library-2.11.5.jar" />
            <zipgroupfileset dir="${base.dir}/lib/" includes="scala-parser-combinators_2.11-1.0.2.jar" />
            <zipgroupfileset dir="${base.dir}/lib/" includes="scala-xml_2.11-1.0.2.jar" />
            <zipgroupfileset dir="${base.dir}/lib" includes="kafka_2.11-0.8.2.2.jar" />
            <zipgroupfileset dir="${base.dir}/lib/" includes="kafka-clients-0.8.2.2.jar" />
            <zipgroupfileset dir="${base.dir}/lib/" includes="snappy-java-1.1.1.7.jar" />
            <zipgroupfileset dir="${base.dir}/lib/" includes="lz4-1.2.0.jar" />
            <manifest>
                <attribute name="Bundle-Activator" value="org.voltdb.importclient.kafka.KafkaStreamImporterFactory" />
                <attribute name="Bundle-ManifestVersion" value="2" />
                <attribute name="Bundle-Name" value="KafkaStream OSGi Bundle" />
                <attribute name="Bundle-SymbolicName" value="KafkaStreamImporter" />
                <attribute name="Bundle-Version" value="1.0.0" />
                <attribute name="DynamicImport-Package" value="*" />
                <attribute name="Import-Package" value="${default.imports}"/>
            </manifest>
        </jar>
    </target>

	 <target name="kafka8junit" depends="kafkastream10">  
	    <javac srcdir="${src.test.dir}" destdir='${build.test.dir}'
            includes="org/voltdb/importer/kafka/**/*.java"
            encoding='UTF-8'
            debug='true'
            includeAntRuntime='false'>            
			<classpath refid="k8classpath"/>
        </javac>  
		<run_junit_tests classpathref='k8classpath'>
			<tests>
		      <fileset dir='${build.test.dir}'>
		          <include name="org/voltdb/importer/kafka/TestKafkaLoaderArgumentParsing.class"/> 	 	          
		      </fileset>
		    </tests>
    	</run_junit_tests>
    </target>
    
	<!-- Kafka 10 -->
	
	<path id="k10classpath">     	
        <pathelement location='${build.client.dir}' />
 	    <pathelement location='${build.prod.dir}' /> 
		<fileset dir='${vendor.lib.dir}'>
			<include name='kafka-clients-0.10.2.1.jar'/>
  		    <include name='junit*.jar'/>
			<exclude name='ant.jar' />
 	        <exclude name='classes-java1.7.jar' />   
 	    </fileset>
 	    <fileset dir='${lib.dir}'> 
 	       <include name='felix.jar'/>
 	    </fileset>
 		<fileset refid="voltpro.classpath"/>
 	</path>
  
    <target name="kafka10junit" depends="kafkastream10">  
	    <javac srcdir="${src.test.dir}" destdir='${build.test.dir}'
            includes="org/voltdb/importer/kafka10/**/*.java"
            encoding='UTF-8'
            debug='true'
            includeAntRuntime='false'>            
			<classpath refid="k10classpath"/>
        </javac>  
		<run_junit_tests classpathref='k10classpath'>
			<tests>
		      <fileset dir='${build.test.dir}'>
		          <include name="org/voltdb/importer/kafka10/TestKafka10BasicConsumer.class"/> 	 	          
		      </fileset>
		    </tests>
    	</run_junit_tests>
    </target>
    
	<macrodef name="run_junit_tests">
	  <attribute name="classpathref"/>
	  <element name="tests"/>
	  <sequential>
		 <mkdir dir="${build.testoutput.dir}"/>
		 <junit fork="yes" haltonfailure="${junit.haltonfailure}" failureproperty="junit.failures" printsummary="false" maxmemory="2048M" showoutput="${junit.showoutput}">
			<classpath>
			   <path refid="@{classpathref}"/>
			   <path refid="project.classpath"/>			  
			</classpath>
			<batchtest todir="${build.testoutput.dir}">
			   <tests/>
			   <formatter type="plain" usefile="false" if="verbosereport"/>
			   <formatter type="plain" usefile="true"/>
			   <formatter type="xml" classname="org.voltdb.VoltJUnitFormatter" usefile="false" extension="none"/>
			   <formatter type="xml"/>
			</batchtest>
			<assertions>
			   <enable/>
			</assertions>
		 </junit>
		 <junitreport todir="${build.testoutput.dir}">
			<fileset dir="${build.testoutput.dir}">
			   <include name="TEST-*.xml"/>
			</fileset>
			<report format="noframes" todir="${build.testoutput.dir}/report"/>
			<report styledir="tools" format="noframes" todir="${build.testoutput.dir}"/>
		 </junitreport>
		 <concat>
			<filelist dir="${build.testoutput.dir}" files="junit-noframes.html"/>
		 </concat>
		 <available file="${build.testoutput.dir}/JUNITHADFAILURES" property="junit.failures"/>
		 <fail if="junit.failures" unless="use_jacoco" message="JUnit had failures"/>
	  </sequential>
	</macrodef>
    
    <target name="kafkastream10">
 	    <javac  srcdir="src/frontend"
            destdir="${build.prod.dir}"
            includes="org/voltdb/importclient/kafka10/**/*.java"
            encoding='UTF-8'
            debug='true'
            includeAntRuntime='false'>            
			<classpath refid="k10classpath"/>
        </javac>
        <mkdir dir="${bundles.dir}" />
        <jar destfile="${bundles.dir}/kafkastream10.jar"  basedir="${build.prod.dir}">
            <include name="org/voltdb/importclient/kafka/*.class"/>
            <include name="org/voltdb/importclient/*.class"/>
   	        <include name="org/voltdb/importclient/kafka10/*.class"/>
   	        <include name="au/com/bytecode/opencsv_voltpatches/**/*.class"/>
            <zipgroupfileset dir="${base.dir}/third_party/java/jars" includes="kafka-clients-0.10.2.1.jar" />
            <zipgroupfileset dir="${base.dir}/third_party/java/jars" includes="snappy-java-1.1.2.6.jar" />
            <zipgroupfileset dir="${base.dir}/third_party/java/jars" includes="lz4-1.3.0.jar" />
            <zipgroupfileset dir="${base.dir}/third_party/java/jars" includes="slf4j-api-1.7.21.jar" />
            <zipgroupfileset dir="${base.dir}/third_party/java/jars" includes="slf4j-log4j12-1.7.21.jar" />
            <zipgroupfileset dir="${base.dir}/third_party/java/jars" includes="log4j-1.2.17.jar" />
            <manifest>
				<attribute name="Bundle-Activator" value="org.voltdb.importclient.kafka10.Kafka10StreamImporterFactory" />
				<attribute name="Bundle-ManifestVersion" value="2" />
				<attribute name="Bundle-Name" value="Kafka10Stream OSGi Bundle" />
				<attribute name="Bundle-SymbolicName" value="Kafka10StreamImporter" />
				<attribute name="Bundle-Version" value="1.0.0" />
				<attribute name="DynamicImport-Package" value="*" />
				<attribute name="Import-Package" value="${default.imports}"/>
			</manifest>  
        </jar>
    </target>

    <!-- Create the Bundle -->
    
    <target name="osgibundle">
        <mkdir dir="${bundles.dir}" />
        <jar destfile="${bundles.dir}//${bundle.name}.jar" basedir="${build.prod.dir}">
            <include name="org/voltdb/importclient/${include.classpattern}"/>
            <manifest>
                <attribute name="Bundle-Activator" value="${activator}" />
                <attribute name="Bundle-ManifestVersion" value="2" />
                <attribute name="Bundle-Name" value="${bundle.displayname} OSGi Bundle" />
                <attribute name="Bundle-SymbolicName" value="${bundle.displayname}" />
                <attribute name="Bundle-Version" value="1.0.0" />
                <attribute name="DynamicImport-Package" value="*" />
                <attribute name="Import-Package" value="${default.imports}" />
            </manifest>
        </jar>
    </target>

    <target name="voltcsvformatter">
        <mkdir dir="${bundles.dir}" />
        <jar destfile="${bundles.dir}/voltcsvformatter.jar" basedir="${build.prod.dir}">
            <include name="org/voltdb/importer/formatter/builtin/*.class"/>
            <include name="org/supercsv_voltpatches/tokenizer/*.class"/>
            <include name="au/com/bytecode/opencsv_voltpatches/CSVParser.class"/>
            <zipgroupfileset dir="${base.dir}/lib" includes="super-csv-2.1.0.jar" />
            <manifest>
                <attribute name="Bundle-Activator" value="org.voltdb.importer.formatter.builtin.VoltCSVFormatterFactory" />
                <attribute name="Bundle-ManifestVersion" value="2" />
                <attribute name="Bundle-Name" value="Builtin CSV Formatter OSGi Bundle" />
                <attribute name="Bundle-SymbolicName" value="VoltCSVFormatter" />
                <attribute name="Bundle-Version" value="1.0.0" />
                <attribute name="DynamicImport-Package" value="*" />
            </manifest>
        </jar>
    </target>

	<target name="importer_junit_tests" depends="kafka8junit, kafka10junit"/>
</project>
